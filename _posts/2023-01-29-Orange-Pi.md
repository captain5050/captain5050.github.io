---
layout: post
title: Setting up Pi Hole on an Orange Pi
subtitle: Making a cheap-ish network filter
tags: [orangepi, pihole]
comments: true
---

My current wifi router has an all or nothing approach to parental controls, I wanted to get a device to allow me to be more specific in blocking things and so here is what I've done so far.

### Getting the OrangePi

I got an [orange pi r1+ LTS](http://www.orangepi.org/html/hardWare/computerAndMicrocontrollers/details/Orange-Pi-R1-Plus-LTS-With-Metal-Case.html
) from [Orange Pi's Ali Express store](https://www.aliexpress.us/item/3256804508750716.html) as Raspberry Pis were low in stock and high in price.
![Orange Pi R1 LTS](http://www.orangepi.org/img/orange-pi-r1-plus-lts-router.png)

I wanted two ethernet ports as the device will filter traffic and an SBC with a USB ethernet port hanging from didn’t sound great to me. I got the metal case as the CPUs/RAM get hot and the thermal mass helps dissipate that without a fan.

The price with case on [AliExpress was $35.99](https://www.aliexpress.us/item/3256804508750716.html) ([price with no case is $27.99](https://www.aliexpress.us/item/3256804506497194.html)), $7.49 shipping and $3.28 tax. Total $46.76.

I splurged a little on a [128GB Samsung “endurance” U3 speed (100/40 MB/s) sd card from Amazon for $15.99](https://www.amazon.com/dp/B09WB1857W?). This is way more than I need for this project and I may downgrade later and use this card in a different project. This brings my total cost to $62.75.

#### Things I liked before getting started

 * Dual ethernet. 
 * Powered off USB-C, should be able to survive on my UPS' USB power with my wifi router and modem during a power cut.
 * Reasonably powerful ARM quad-core - although spec is a few years old.
 * Very small and self contained.
 * Price.

#### Things I didn't like

 * 1GB of RAM feels small, especially compared to typical phone RAM sizes. That said with no GPU then lowering the price is good. Also, Pi Hole should be good with just 512MB of RAM.
 * Early Cortex A53s were full of bugs, so fingers crossed here.
 * OrangePi is understandably Chinese focused and I wanted to run a more stock distro - would have preferred a cheap Raspberry Pi with this kind of configuration.
 * One ethernet port is internally over USB.
 * The name - what's the significance of LTS?

### Getting started

Once you have the OrangePi the next thing you'll need to do is set it up.

 * Download and image sdcard
   * On [orangepi.org](http://www.orangepi.org/) there is a downloads section where you [select the R1+ LTS](http://www.orangepi.org/html/hardWare/computerAndMicrocontrollers/service-and-support/Orange-Pi-R1-Plus-LTS.html).
   * Follow the [ubuntu link that opens Google drive](https://drive.google.com/drive/folders/1HpBG4UeRE1fXVlajXG3O7N7m78KSRY3X) and download the newer focal release (ubuntu 20.04).
   * Follow a [guide on SD card image writing](https://learn.sparkfun.com/tutorials/sd-cards-and-writing-images/all).
 * Mount the sdcard and copy the file `/boot/orangepi_first_run.txt.template` to `/boot/orangepi_first_run.txt`.
 * Edit `/boot/orangepi_first_run.txt`.
   * It is a bit nerve-racking booting the Orange Pi as there is no screen or keyboard, you are just hoping it will start and you can connect to it some how. I'd suggest connecting the device to your network as a regular dynamic IP address client using the LAN port of your router and the LAN port on the device. My router allows me to see the assigned IP address as well as make it the same every time. The `/boot/orangepi_first_run.txt` does allow a static IP assignment and you can connect the device to ethernet without a cross-over cable, but I didn't get very far with this and it was easier to just go the dynamic IP address route until I could log into the device and set it up.
 * Put the sdcard in the Orange Pi R1+ LTS, make sure the LAN is connected to the router and power on.
 * If everything went according to plan it takes just seconds to boot and you can ssh to the device `ssh root@192.168.x.y`. The password is initially set to `orangepi`.

### Updating to the latest ubuntu

I wanted to update the ubuntu on the image and hopefully get it closer to stock.
 * Switching from to a US repository.
   * The image is set up to download ubuntu packages from http://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ which isn't particularly quick in the US.
   * Modify `/etc/apt/sources.list` and change http://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ to http://ports.ubuntu.com/ubuntu-ports. I did this by first `apt install`-ing emacs. Commenting out the original lines and making modified versions with search and replace. The 4 lines looked like:
```
deb http://ports.ubuntu.com/ubuntu-ports/ focal main restricted universe multiverse
deb http://ports.ubuntu.com/ubuntu-ports/ focal-security main restricted universe multiverse
deb http://ports.ubuntu.com/ubuntu-ports/ focal-updates main restricted universe multiverse
deb http://ports.ubuntu.com/ubuntu-ports/ focal-backports main restricted universe multiverse
```
 * Next was doing the upgrade (no sudo as I was logged in as root, there's a `-d` option for `do-release-upgrade` if you want a development release):
```bash
$ apt update
$ apt upgrade
$ apt install update-manager-core
$ do-release-upgrade
```

### Setup networking

#### Setup a dhcp server on the LAN port
